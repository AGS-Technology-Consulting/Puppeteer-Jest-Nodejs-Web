name: Puppeteer POM Framework - CI/CD

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - production

env:
  NODE_VERSION: '18.x'
  HEADLESS: 'true'
  BASE_URL: 'https://the-internet.herokuapp.com'

jobs:
  test:
    name: Run Puppeteer Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: ğŸ” Environment Information
        run: |
          echo "Node Version: $(node --version)"
          echo "NPM Version: $(npm --version)"
          echo "Puppeteer Version: $(npm list puppeteer --depth=0 | grep puppeteer)"
          echo "Base URL: $BASE_URL"
          echo "Headless Mode: $HEADLESS"

      - name: ğŸ§ª Run Tests
        run: |
          echo "ğŸ§ª Running Puppeteer tests..."
          npm run test:ci
        env:
          CI: true
          HEADLESS: ${{ env.HEADLESS }}
          BASE_URL: ${{ env.BASE_URL }}
          NODE_ENV: test

      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          echo "ğŸ“Š Generating Allure report..."
          npm run allure:generate || true

      - name: ğŸ“¸ Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.node-version }}
          path: screenshots/
          retention-days: 30

      - name: ğŸ“‹ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: test-results/
          retention-days: 30

      - name: ğŸ“ˆ Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.node-version }}
          path: allure-results/
          retention-days: 30

      - name: ğŸ“ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.node-version }}
          path: logs/
          retention-days: 30

      - name: ğŸ“Š Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: test-results/*.xml
          check_name: Test Results (${{ matrix.node-version }})

  allure-report:
    name: Generate and Deploy Allure Report
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true

      - name: ğŸ“Š Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: ğŸš€ Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  notify:
    name: Send Notifications
    needs: [test, allure-report]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“§ Send Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            *Puppeteer Test Execution ${{ job.status }}*
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
            Run: ${{ github.run_number }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: |
          echo "Running ESLint..."
          npx eslint . --ext .js || true

      - name: ğŸ“Š SonarCloud Scan
        if: github.event_name != 'pull_request'
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”’ Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || true

      - name: ğŸ” Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@v4
